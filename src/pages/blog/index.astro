---
import { getCollection } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import Header from '../../components/Header.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';

const allPosts = (await getCollection('blog')).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

// 只保留最近三篇文章
const posts = allPosts.slice(0, 3);

// 为每篇文章添加标签数据（如果没有标签，则默认为空数组）
const postsWithTags = posts.map((post) => ({
	...post,
	data: {
		...post.data,
		tags: post.data.tags || [],
	},
}));
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
		<style>
			main {
				display: flex;
				gap: 3rem;
				width: 100%;
				max-width: 1200px;
				margin: 0 auto;
				padding: 2em 1em;
			}
			.tags-sidebar {
				flex-shrink: 0;
				width: 150px;
			}
			.tags-list {
				list-style-type: none;
				margin: 0;
				padding: 0;
			}
			.tags-list li {
				margin-bottom: 1em;
			}
			.tag-button {
				display: block;
				width: 100%;
				padding: 0.5em 0;
				background: none;
				border: none;
				color: rgb(var(--black));
				font-size: 1em;
				font-family: inherit;
				cursor: pointer;
				text-align: left;
				transition: all 0.2s ease;
			}
			.tag-button:hover {
				color: var(--accent);
			}
			.tag-button.active {
				font-weight: 700;
			}
			.content-area {
				flex: 1;
				min-width: 0;
			}
			.post-list {
				list-style-type: none;
				margin: 0;
				padding: 0;
			}
			.post-item {
				margin-bottom: 2em;
				padding-bottom: 2em;
				border-bottom: 1px solid rgb(var(--gray-light));
				display: none;
			}
			.post-item.show {
				display: block;
			}
			.post-item:last-child {
				border-bottom: none;
				margin-bottom: 0;
				padding-bottom: 0;
			}
			.post-link {
				text-decoration: none;
				color: inherit;
				display: block;
				transition: color 0.2s ease;
			}
			.post-link:hover {
				color: var(--accent);
			}
			.post-link:hover .post-title {
				color: var(--accent);
			}
			.post-title {
				margin: 0 0 0.5em 0;
				color: rgb(var(--black));
				line-height: 1.3;
				font-size: 1.25em;
				font-weight: 700;
			}
			.post-meta {
				margin: 0 0 1em 0;
				color: rgb(var(--gray));
				font-size: 0.9em;
				display: flex;
				align-items: center;
				gap: 0.75em;
				flex-wrap: wrap;
			}
			.post-tags {
				display: flex;
				gap: 0.5em;
				flex-wrap: wrap;
			}
			.post-tag {
				display: inline-block;
				padding: 0.25em 0.75em;
				background: rgb(var(--gray-light));
				border-radius: 4px;
				font-size: 0.85em;
				color: rgb(var(--gray-dark));
			}
			@media (max-width: 720px) {
				main {
					flex-direction: column;
				}
				.tags-sidebar {
					width: 100%;
				}
				.tags-list {
					display: flex;
					gap: 1em;
					flex-wrap: wrap;
				}
				.tags-list li {
					margin-bottom: 0;
				}
				.tag-button {
					text-align: center;
					padding: 0.5em 1em;
				}
			}
		</style>
	</head>
	<body>
		<Header />
		<main>
			<aside class="tags-sidebar">
				<ul class="tags-list">
					<li>
						<button class="tag-button active" data-tag="全部">全部</button>
					</li>
					<li>
						<button class="tag-button" data-tag="思考">思考</button>
					</li>
					<li>
						<button class="tag-button" data-tag="创业">创业</button>
					</li>
					<li>
						<button class="tag-button" data-tag="产品">产品</button>
					</li>
					<li>
						<button class="tag-button" data-tag="投资">投资</button>
					</li>
				</ul>
			</aside>
			<section class="content-area">
				<ul class="post-list">
					{
						postsWithTags.map((post, index) => (
							<li class="post-item show" data-tags={JSON.stringify(post.data.tags)}>
								<a href={`/blog/${post.id}/`} class="post-link">
									<h4 class="post-title">{post.data.title}</h4>
									<p class="post-meta">
										<FormattedDate date={post.data.pubDate} />
										{post.data.tags && post.data.tags.length > 0 && (
											<span class="post-tags">
												{post.data.tags.map((tag) => (
													<span class="post-tag">{tag}</span>
												))}
											</span>
										)}
									</p>
								</a>
							</li>
						))
					}
				</ul>
			</section>
		</main>
		<Footer />
		<script is:inline>
			document.addEventListener('DOMContentLoaded', function() {
				const tagButtons = document.querySelectorAll('.tag-button');
				const postItems = document.querySelectorAll('.post-item');

				tagButtons.forEach(function(button) {
					button.addEventListener('click', function(event) {
						const target = event.currentTarget;
						const selectedTag = target.getAttribute('data-tag');
						
						// 更新按钮状态
						tagButtons.forEach(function(btn) {
							btn.classList.remove('active');
						});
						target.classList.add('active');

						// 筛选文章
						postItems.forEach(function(item) {
							if (selectedTag === '全部') {
								item.classList.add('show');
							} else {
								const tags = JSON.parse(item.getAttribute('data-tags') || '[]');
								if (tags.includes(selectedTag)) {
									item.classList.add('show');
								} else {
									item.classList.remove('show');
								}
							}
						});
					});
				});
			});
		</script>
	</body>
</html>
